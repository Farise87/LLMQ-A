<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中医药推荐平台 - 管理后台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        :root {
            --primary-color: #5891a6;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-bg: #f5f7fa;
            --dark-bg: #34495e;
            --success: #2ecc71;
            --warning: #f39c12;
            --text-color: #333;
            --light-text: #ecf0f1;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: var(--light-bg);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 250px;
            background: var(--dark-bg);
            color: var(--light-text);
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .sidebar-header h2 {
            font-size: 1.5rem;
            margin: 10px 0;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
        }
        
        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            color: var(--secondary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .logout-btn {
            margin-left: 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .home-btn {
            margin-left: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .home-btn:hover {
            background: #2980b9;
        }
        
        /* 卡片样式 */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 1rem;
            color: var(--secondary-color);
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        /* 表格样式 */
        .content-section {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--secondary-color);
        }
        
        .action-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }
        
        .action-button:hover {
            background: #2980b9;
        }
        
           table {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto; /* 默认值，列宽由内容决定 */
    }

    thead {
        background: #f8f9fa;
    }

    th {
        padding: 12px;
        text-align: left;
        font-size: clamp(12px, 1.5vw, 16px); /* 响应式字体大小 */
        white-space: nowrap; /* 防止文字换行 */
        min-width: 100px; /* 最小宽度，防止内容过挤 */
    }

    td {
        padding: 8px;
        border: 1px solid #ddd;
    }
        tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        /* Specific table column widths */
        .medicine-table th, 
        .medicine-table td {
            white-space: nowrap;
            padding: 8px 12px;
        }

        .medicine-table {
            table-layout: auto;
            width: 100%;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        
        .status-inactive {
            background: rgba(231, 76, 60, 0.15);
            color: var(--accent-color);
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-edit, .btn-delete {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-edit {
            color: var(--primary-color);
        }
        
        .btn-delete {
            color: var(--accent-color);
        }
        
        .btn-edit:hover, .btn-delete:hover {
            transform: scale(1.1);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                padding: 20px 0;
            }
            
            .sidebar-header h2, .menu-item span {
                display: none;
            }
            
            .menu-item {
                justify-content: center;
                padding: 15px 0;
            }
            
            .menu-item i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取药材和方剂总数
            fetch('/api/admin/counts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取统计数据失败');
                    }
                    return response.json();
                })
                .then(data => {
                    const medicineCountElement = document.getElementById('medicine-count-value');
                    const herbCountElement = document.getElementById('herb-count-value');
                    if (medicineCountElement) {
                        medicineCountElement.textContent = data.medicine_count !== undefined ? data.medicine_count : 'N/A';
                    }
                    if (herbCountElement) {
                        herbCountElement.textContent = data.herb_count !== undefined ? data.herb_count : 'N/A';
                    }
                })
                .catch(error => {
                    console.error('加载统计数据出错:', error);
                    const medicineCountElement = document.getElementById('medicine-count-value');
                    const herbCountElement = document.getElementById('herb-count-value');
                    if (medicineCountElement) medicineCountElement.textContent = '错误';
                    if (herbCountElement) herbCountElement.textContent = '错误';
                });
        });
    </script>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>中医药管理平台</h2>
        </div>
        <div class="sidebar-menu">

            <div class="menu-item">
                <i class="fas fa-leaf"></i>
                <span>药材管理</span>
            </div>
            <div class="menu-item">
                <i class="fas fa-mortar-pestle"></i>
                <span>方剂管理</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-newspaper"></i>
                <span>文章管理</span>
            </div>

        </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="header">
            <h1>管理员控制面板</h1>
            <div class="user-info">
                <div class="user-avatar">A</div>
                <span>欢迎, {{ session.username }}</span>
                <a href="/logout" class="logout-btn">登出</a>
                <a href="/" class="home-btn"><i class="fas fa-home"></i> 返回首页</a>
            </div>
        </div>
        
        <!-- 数据概览卡片 -->
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">药材总数</div>
                        <div class="card-value" id="medicine-count-value">...</div>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                </div>
                <div class="card-footer">
                    较上月增加 <span style="color: var(--success);">12</span> 种
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">方剂总数</div>
                        <div class="card-value" id="herb-count-value">...</div>
                    </div>
                    <div class="card-icon" style="background: rgba(231, 76, 60, 0.1); color: var(--accent-color);">
                        <i class="fas fa-mortar-pestle"></i>
                    </div>
                </div>
                <div class="card-footer">
                    较上月增加 <span style="color: var(--success);">8</span> 种
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">本月访问量</div>
                        <div class="card-value">12,843</div>
                    </div>
                    <div class="card-icon" style="background: rgba(46, 204, 113, 0.1); color: var(--success);">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="card-footer">
                    较上月增长 <span style="color: var(--success);">23.5%</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">智能推荐次数</div>
                        <div class="card-value">1,562</div>
                    </div>
                    <div class="card-icon" style="background: rgba(243, 156, 18, 0.1); color: var(--warning);">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="card-footer">
                    较上月增长 <span style="color: var(--success);">15.2%</span>
                </div>
            </div>
        </div>
        
        <!-- 最新药材表格 -->
        <div class="content-section">
            <div class="section-header">
                <h3 class="section-title">最新添加药材</h3>
                <button class="action-button">
                    <i class="fas fa-plus"></i> 添加药材
                </button>
            </div>
            
            <table class="medicine-table">  <!-- Added class here -->
                <thead>
                    <tr>
                        <th>药材名称</th>
                        <th>分类</th>
                        <th>添加时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>黄芪</td>
                        <td>补气类</td>
                        <td>2023-10-18</td>
                        <td><span class="status status-active">已上线</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td>当归</td>
                        <td>补血类</td>
                        <td>2023-10-15</td>
                        <td><span class="status status-active">已上线</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td>红参</td>
                        <td>补气类</td>
                        <td>2023-10-12</td>
                        <td><span class="status status-pending">审核中</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td>三七</td>
                        <td>活血类</td>
                        <td>2023-10-10</td>
                        <td><span class="status status-inactive">未上线</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 最新方剂表格 -->
        <div class="content-section">
            <div class="section-header">
                <h3 class="section-title">最新添加方剂</h3>
                <button class="action-button">
                    <i class="fas fa-plus"></i> 添加方剂
                </button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>方剂名称</th>
                        <th>分类</th>
                        <th>添加时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>四君子汤</td>
                        <td>补气类</td>
                        <td>2023-10-20</td>
                        <td><span class="status status-active">已上线</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td>四物汤</td>
                        <td>补血类</td>
                        <td>2023-10-18</td>
                        <td><span class="status status-active">已上线</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td>桂枝汤</td>
                        <td>解表类</td>
                        <td>2023-10-15</td>
                        <td><span class="status status-pending">审核中</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td>六味地黄丸</td>
                        <td>滋阴类</td>
                        <td>2023-10-12</td>
                        <td><span class="status status-inactive">未上线</span></td>
                        <td class="actions">
                            <button class="btn-edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 模态框 - 药材编辑 -->
    <div id="medicineModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; width: 80%; max-width: 600px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 id="medicineModalTitle">添加药材</h3>
                <span class="close-btn" onclick="closeMedicineModal()" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <form id="medicineForm">
                <input type="hidden" id="medicineId">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="medicineName" style="display: block; margin-bottom: 5px;">药材名称:</label>
                    <input type="text" id="medicineName" name="药材" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="medicineAlias" style="display: block; margin-bottom: 5px;">别名:</label>
                    <input type="text" id="medicineAlias" name="别名" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="medicineFunction" style="display: block; margin-bottom: 5px;">功用:</label>
                    <input type="text" id="medicineFunction" name="功用" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="medicineIntro" style="display: block; margin-bottom: 5px;">药材简介:</label>
                    <textarea id="medicineIntro" name="药材简介" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="form-actions" style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeMedicineModal()" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; margin-right: 10px;">取消</button>
                    <button type="submit" style="padding: 8px 15px; background: var(--primary-color); color: white; border: none; border-radius: 4px;">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 模态框 - 方剂编辑 -->
    <div id="herbModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; width: 80%; max-width: 600px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 id="herbModalTitle">添加方剂</h3>
                <span class="close-btn" onclick="closeHerbModal()" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <form id="herbForm">
                <input type="hidden" id="herbId">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="herbName" style="display: block; margin-bottom: 5px;">方剂名称:</label>
                    <input type="text" id="herbName" name="药剂" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="herbFunction" style="display: block; margin-bottom: 5px;">功用:</label>
                    <input type="text" id="herbFunction" name="功用" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="herbSymptoms" style="display: block; margin-bottom: 5px;">症状:</label>
                    <input type="text" id="herbSymptoms" name="症状" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="herbComposition" style="display: block; margin-bottom: 5px;">组成:</label>
                    <textarea id="herbComposition" name="组成" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="form-actions" style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeHerbModal()" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; margin-right: 10px;">取消</button>
                    <button type="submit" style="padding: 8px 15px; background: var(--primary-color); color: white; border: none; border-radius: 4px;">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 确认删除模态框 -->
    <div id="confirmDeleteModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; width: 80%; max-width: 400px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3>确认删除</h3>
                <span class="close-btn" onclick="closeConfirmDeleteModal()" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <p id="deleteConfirmText">确定要删除这条记录吗？此操作无法撤销。</p>
            <div class="form-actions" style="text-align: right; margin-top: 20px;">
                <button type="button" onclick="closeConfirmDeleteModal()" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; margin-right: 10px;">取消</button>
                <button type="button" id="confirmDeleteBtn" style="padding: 8px 15px; background: var(--accent-color); color: white; border: none; border-radius: 4px;">删除</button>
            </div>
        </div>
    </div>
    
    <!-- 通知提示 -->
    <div id="notification" style="display: none; position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; background: var(--success); color: white; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000;"></div>

    <script>
        // 菜单项点击效果
        const menuItems = document.querySelectorAll('.menu-item');
        let activeSectionId = 'dashboard';
        let currentDataType = '';
        let deleteItemInfo = { type: '', id: null };
        
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                // 移除所有active类
                menuItems.forEach(i => i.classList.remove('active'));
                // 添加当前项的active类
                this.classList.add('active');
                
                // 根据点击的菜单项切换显示内容
                const menuText = this.querySelector('span').textContent.trim();
                switch(menuText) {
                    case '控制面板':
                        showSection('dashboard');
                        break;
                    case '药材管理':
                        showSection('medicines');
                        loadMedicines();
                        break;
                    case '方剂管理':
                        showSection('herbs');
                        loadHerbs();
                        break;
                    case '文章管理':
                        showSection('articles');
                        break;
                    case '系统设置':
                        showSection('settings');
                        break;
                }
            });
        });
        
        // 显示指定部分内容
        function showSection(sectionId) {
            activeSectionId = sectionId;
            
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // 显示当前内容区域
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.style.display = 'block';
            }
        }
        
        // 加载所有药材数据
        function loadMedicines() {
            fetch('/api/admin/medicines')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取药材数据失败');
                    }
                    return response.json();
                })
                .then(data => {
                    renderMedicinesTable(data);
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
        }
        
        // 加载所有方剂数据
        function loadHerbs() {
            fetch('/api/admin/herbs')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取方剂数据失败');
                    }
                    return response.json();
                })
                .then(data => {
                    renderHerbsTable(data);
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
        }
        
        // 渲染药材表格
        function renderMedicinesTable(medicines) {
            const tableBody = document.querySelector('#medicinesTable tbody');
            if (!tableBody) {
                // 如果表格不存在，创建表格
                createMedicinesTable(medicines);
                return;
            }
            
            tableBody.innerHTML = '';
            medicines.forEach(medicine => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${medicine.药材 || ''}</td>
                    <td>${medicine.别名 || ''}</td>
                    <td>${medicine.功用 || ''}</td>
                    <td>${new Date(medicine.创建时间 || Date.now()).toLocaleDateString()}</td>
                    <td><span class="status status-active">已上线</span></td>
                    <td class="actions">
                        <button class="btn-edit" onclick="editMedicine(${medicine.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="confirmDelete('medicine', ${medicine.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 渲染方剂表格
        function renderHerbsTable(herbs) {
            const tableBody = document.querySelector('#herbsTable tbody');
            if (!tableBody) {
                // 如果表格不存在，创建表格
                createHerbsTable(herbs);
                return;
            }
            
            tableBody.innerHTML = '';
            herbs.forEach(herb => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${herb.药剂 || ''}</td>
                    <td>${herb.功用 || ''}</td>
                    <td>${new Date(herb.创建时间 || Date.now()).toLocaleDateString()}</td>
                    <td><span class="status status-active">已上线</span></td>
                    <td class="actions">
                        <button class="btn-edit" onclick="editHerb(${herb.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="confirmDelete('herb', ${herb.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 创建药材表格
        function createMedicinesTable(medicines) {
            const mainContent = document.querySelector('.main-content');
            const section = document.createElement('div');
            section.id = 'medicines';
            section.className = 'content-section';
            section.style.display = 'none';
            
            section.innerHTML = `
                <div class="section-header">
                    <h3 class="section-title">药材管理</h3>
                    <button class="action-button" onclick="openAddMedicineModal()">
                        <i class="fas fa-plus"></i> 添加药材
                    </button>
                </div>
                
                <table id="medicinesTable">
                    <thead>
                        <tr>
                            <th>药材名称</th>
                            <th>别名</th>
                            <th>功用</th>
                            <th>添加时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            `;
            
            mainContent.appendChild(section);
            renderMedicinesTable(medicines);
        }
        
        // 创建方剂表格
        function createHerbsTable(herbs) {
            const mainContent = document.querySelector('.main-content');
            const section = document.createElement('div');
            section.id = 'herbs';
            section.className = 'content-section';
            section.style.display = 'none';
            
            section.innerHTML = `
                <div class="section-header">
                    <h3 class="section-title">方剂管理</h3>
                    <button class="action-button" onclick="openAddHerbModal()">
                        <i class="fas fa-plus"></i> 添加方剂
                    </button>
                </div>
                
                <table id="herbsTable">
                    <thead>
                        <tr>
                            <th>方剂名称</th>
                            <th>功用</th>
                            <th>添加时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            `;
            
            mainContent.appendChild(section);
            renderHerbsTable(herbs);
        }
        
        // 打开添加药材模态框
        function openAddMedicineModal() {
            document.getElementById('medicineModalTitle').textContent = '添加药材';
            document.getElementById('medicineForm').reset();
            document.getElementById('medicineId').value = '';
            document.getElementById('medicineModal').style.display = 'flex';
        }
        
        // 打开编辑药材模态框
        function editMedicine(id) {
            fetch(`/api/admin/medicines/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取药材数据失败');
                    }
                    return response.json();
                })
                .then(medicine => {
                    document.getElementById('medicineModalTitle').textContent = '编辑药材';
                    document.getElementById('medicineId').value = medicine.id;
                    document.getElementById('medicineName').value = medicine.药材 || '';
                    document.getElementById('medicineAlias').value = medicine.别名 || '';
                    document.getElementById('medicineFunction').value = medicine.功用 || '';
                    document.getElementById('medicineIntro').value = medicine.药材简介 || '';
                    document.getElementById('medicineModal').style.display = 'flex';
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
        }
        
        // 关闭药材模态框
        function closeMedicineModal() {
            document.getElementById('medicineModal').style.display = 'none';
        }
        
        // 打开添加方剂模态框
        function openAddHerbModal() {
            document.getElementById('herbModalTitle').textContent = '添加方剂';
            document.getElementById('herbForm').reset();
            document.getElementById('herbId').value = '';
            document.getElementById('herbModal').style.display = 'flex';
        }
        
        // 打开编辑方剂模态框
        function editHerb(id) {
            fetch(`/api/admin/herbs/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取方剂数据失败');
                    }
                    return response.json();
                })
                .then(herb => {
                    document.getElementById('herbModalTitle').textContent = '编辑方剂';
                    document.getElementById('herbId').value = herb.id;
                    document.getElementById('herbName').value = herb.药剂 || '';
                    document.getElementById('herbFunction').value = herb.功用 || '';
                    document.getElementById('herbSymptoms').value = herb.症状 || '';
                    document.getElementById('herbComposition').value = herb.组成 || '';
                    document.getElementById('herbModal').style.display = 'flex';
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
        }
        
        // 关闭方剂模态框
        function closeHerbModal() {
            document.getElementById('herbModal').style.display = 'none';
        }
        
        // 确认删除
        function confirmDelete(type, id) {
            deleteItemInfo.type = type;
            deleteItemInfo.id = id;
            
            const confirmText = type === 'medicine' ? '确定要删除这个药材吗？此操作无法撤销。' : '确定要删除这个方剂吗？此操作无法撤销。';
            document.getElementById('deleteConfirmText').textContent = confirmText;
            document.getElementById('confirmDeleteModal').style.display = 'flex';
        }
        
        // 关闭确认删除模态框
        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
        }
        
        // 显示通知提示
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? 'var(--success)' : 'var(--accent-color)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 初始化事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 药材表单提交
            document.getElementById('medicineForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const medicineId = document.getElementById('medicineId').value;
                const medicineData = {
                    药材: document.getElementById('medicineName').value,
                    别名: document.getElementById('medicineAlias').value,
                    功用: document.getElementById('medicineFunction').value,
                    药材简介: document.getElementById('medicineIntro').value
                };
                
                const url = medicineId ? `/api/admin/medicines/${medicineId}` : '/api/admin/medicines';
                const method = medicineId ? 'PUT' : 'POST';
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(medicineData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('操作失败');
                    }
                    return response.json();
                })
                .then(data => {
                    closeMedicineModal();
                    loadMedicines();
                    showNotification(data.message || '操作成功');
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
            });
            
            // 方剂表单提交
            document.getElementById('herbForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const herbId = document.getElementById('herbId').value;
                const herbData = {
                    药剂: document.getElementById('herbName').value,
                    功用: document.getElementById('herbFunction').value,
                    症状: document.getElementById('herbSymptoms').value,
                    组成: document.getElementById('herbComposition').value
                };
                
                const url = herbId ? `/api/admin/herbs/${herbId}` : '/api/admin/herbs';
                const method = herbId ? 'PUT' : 'POST';
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(herbData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('操作失败');
                    }
                    return response.json();
                })
                .then(data => {
                    closeHerbModal();
                    loadHerbs();
                    showNotification(data.message || '操作成功');
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
            });
            
            // 确认删除按钮
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const { type, id } = deleteItemInfo;
                const url = type === 'medicine' ? `/api/admin/medicines/${id}` : `/api/admin/herbs/${id}`;
                
                fetch(url, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除失败');
                    }
                    return response.json();
                })
                .then(data => {
                    closeConfirmDeleteModal();
                    type === 'medicine' ? loadMedicines() : loadHerbs();
                    showNotification(data.message || '删除成功');
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
            });
            
            // 默认显示控制面板
            showSection('dashboard');
        });
    </script>
</body>
</html>